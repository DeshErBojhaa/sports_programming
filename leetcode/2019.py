from functools import cache
from operator import le
from typing import List
import re

def valid_eval(ss):
    tmp, i = [], 0
    while i < len(ss):
        if ss[i] == '*':
            tmp[-1] *= ss[i+1]
            i += 2
            continue
        if ss[i] != '+':
            tmp.append(ss[i])
        i += 1
    return sum(tmp)

def scoreOfStudents(s: str, answers: List[int]) -> int:
    mx = max(answers + [1000])

    @cache
    def all_evals(ss):
        ss = re.split(r'([+*])', ss)

        if len(ss) == 1:
            val = int(ss[0])
            if val <= mx:
                return {val}
            return set()
        
        ans = set()
        for i, ch in enumerate(ss):
            if ch != '+' and ch != '*':
                continue
            left_str = ''.join(ss[:i])
            left = all_evals(left_str)
            if not left:
                continue
            right_str = ''.join(ss[i+1:])
            right = all_evals(right_str)
            if not right:
                continue
            for x in left:
                for y in right:
                    if ch == '+':
                        if x + y > mx:
                            continue
                        ans.add(x + y)
                    else:
                        if x * y > mx:
                            continue
                        ans.add(x * y)
        return ans
    
    invalids = all_evals(s)

    ss = [int(x) if i%2==0 else x for i, x in enumerate(s)]
    sm, valid = 0, valid_eval(ss)
    for a in answers:
        if a == valid:
            sm += 5
        elif a in invalids:
            sm += 2
    return sm

scoreOfStudents("7+9*0", [0])
# x = scoreOfStudents("7+8*2+3*7+8+9*5+4*8+8*5+8*9+4", [855,654,627,564,621,952,669,957,443,289,743,245,731,592,245,254,837,771,724,245,667,734,102,754,901,245,523,389,506,964,689,40,245,546,245,245,865,245,245,786,838,524,633,245,631,952,386,245,372,245,245,719,245,842,910,301,801,213,363,245,245,400,370,245,245,245,488,252,519,500,245,245,416,245,245,687,603,385,245,769,245,616,899,668,754,245,814,599,611,924,851,245,981,245,452,245,736,917,788,245,866,814,958,245,887,245,364,764,308,468,448,533,261,732,496,439,479,17,245,916,686,245,592,792,245,245,828,245,708,471,245,785,245,438,928,777,245,604,802,245,634,413,991,82,245,318,765,847,975,623,40,245,245,245,661,667,411,663,884,245,829,862,245,256,156,680,873,245,623,286,245,461,245,245,529,836,981,199,911,908,245,497,703,889,368,245,245,629,793,364,536,0,377,54,245,513,998,731,471,481,245,245,989,245,245,807,245,531,150,245,958,943,529,245,320,231,986,724,245,604,553,827,195,837,827,979,701,739,523,369,71,245,245,681,296,215,582,245,763,931,488,678,529,581,464,651,179,832,245,988,245,457,779,245,997,245,481,892,245,942,789,656,204,880,245,245,632,777,245,245,743,721,452,245,994,594,645,637,752,606,880,930,245,932,684,443,927,671,734,928,803,245,493,245,820,676,245,245,870,245,903,802,592,543,744,651,536,245,941,563,245,245,245,566,442,255,245,206,329,828,824,536,904,604,829,245,245,694,346,562,497,505,725,719,245,889,245,975,453,245,245,245,643,245,376,245,91,245,978,868,245,245,661,902,245,588,483,793,661,599,245,245,937,731,820,168,245,245,997,769,203,245,752,742,829,74,245,710,722,245,358,975,178,245,769,418,245,475,915,971,590,961,220,978,245,245,985,245,812,119,363,435,393,245,56,472,245,11,580,245,381,728,484,730,719,245,397,256,656,523,245,245,245,734,857,419,890,561,676,976,873,245,245,595,672,998,566,932,245,245,271,880,245,976,245,245,292,747,245,527,605,980,633,965,479,934,285,245,245,489,726,180,855,440,575,476,180,829,245,245,251,843,862,990,808,354,947,245,245,884,479,245,245,245,245,489,245,213,602,245,245,811,852,877,7,245,548,806,909,704,245,949,65,651,666,612,245,8,551,245,245,245,245,245,245,510,754,567,296,916,934,53,245,245,245,777,417,560,508,241,245,862,532,944,728,533,465,432,943,855,245,648,958,867,220,761,724,513,876,85,245,995,827,255,401,585,621,612,261,968,600,797,728,869,245,840,915,245,411,451,182,847,719,152,823,245,475,64,513,603,712,924,245,575,995,245,245,245,800,482,245,245,824,487,511,794,275,245,945,245,245,969,499,245,1000,245,631,102,510,539,210,245,703,472,245,245,670,245,208,245,245,245,245,684,154,918,903,245,928,768,592,912,29,744,54,245,650,583,245,245,177,245,464,383,245,858,602,723,884,617,245,529,245,381,227,677,479,336,826,742,897,110,245,721,16,245,662,728,441,245,858,838,48,245,971,646,872,245,422,171,679,865,245,245,245,765,320,739,857,245,585,347,245,893,684,958,482,245,195,751,617,325,918,878,595,927,447,621,723,532,945,245,609,245,300,546,765,245,963,852,245,245,417,245,534,682,291,41,489,245,697,245,560,802,245,245,245,731,245,245,759,245,726,668,245,923,928,245,33,487,606,958,649,381,245,988,747,543,879,594,245,245,370,952,245,535,245,979,401,997,529,672,681,245,969,879,646,876,968,968,734,686,245,245,725,513,292,173,245,548,245,915,771,245,401,890,525,934,245,706,245,245,488,245,245,644,914,26,245,426,827,245,543,245,693,245,245,482,245,245,673,35,523,916,837,245,949,584,51,245,889,74,245,784,857,245,245,736,569,380,964,245,245,390,737,871,165,894,51,245,724,118,745,705,245,863,245,245,116,443,343,245,949,245,800,121,540,849,630,245,245,486,245,598,525,245,668,425,312,739,219,245,758,405,536,288,245,245,850,497,245,245,287,245,972,248,469,245,844,528,475,783,245,479,245,245,990,485,530,806,187,245,730,252,784,26,768,217,921,561,543,245,682,245,588,313,245,777,245,588,254,927,500,716,245,711,769,245,546,423,245,651,23,245,336,662,927,787,753,245,433,726,709,933,973,956,884,840,945,892,245,245,483,717,832,992,447,584,516,358,305,952,839,555,819,687,272,178,245,245,480,845,683,724,245,947,245,611,876,245,898,245,245,762,946,245,951,311,450,966,974,352,141,553,245,599,245,746,245,741,885,729,737,785,245,580,844,598,245,245,245,174,245,245,572,707,150,794,636,536,104,794,245,637,623,488,528,245,651,245,679,689,245,993,928,663,658,568,388,245,930,546,245,720,908,166,764,245,245,152,252,245,919,309,604,245,245,544,974,901,50,176,855,361,245,245,701,369,532,245,245,505,688,245,227,821,739,647,984,150,621,730,919,494,289,245,245,540,793,672,156,383,245,666,25,775,117,678,733,770,644,245,245,245,245,661,843,826,353,245,747,559,748,245,386,245,245,993,542,627,903,540,868,245,590,386,706,861,860,245,971,245,245,989,121,855,822,245,199,559,711,245,631,928,622,503,170,801,289,245,245,981,516,674,245,922,730,242,764,440,732,574,245,803,775,735,245,245,690,489,844,245,404,606,245,102,245,886,245,847,5,926,556,1,245,245,190,704,58,245,396,814,726,245,133,164,824,797,4,164,443,245,378,97,135,718,785,531,245,973,644,245,245,796,222,405,379,245,245,937,245,245,379,760,595,245,245,782,964,838,762,617,796,884,475,915,245,808,582,659,774,681,29,677,245,402,849,738,391,245,229,212,524,600,974,604,850,560,949,905,396,245,909,631,245,947,881,918,958,245,69,756,964,245,826,932,245,245,245,792,561,220,245,972,892,169,947,868,798,850,553,854,245,745,305,748,698,653,245,862,245,881,513,96,289,921,749,245,836,782,723,424,845,245,717,569,735,560,245,245,811,231,466,987,245,652,948,972,245,245,245,664,245,161,749,412,655,640,245,836,669,565,245,869,860,98,245,814,186,956,245,590,728,803,245,711,245,245,245,245,780,245,525,245,245,245,921,245,559,464,686,408,245,245,908,245,535,959,572,245,245,551,119,847,632,245,622,58,946,518,283,245,245,621,503,698,793,1000,245,628,245,486,736,888,185,245,245,374,782,537,846,640,689,866,245,669,763,681,245,873,395,245,909,960,245,646,592,245,964,511,560,245,245,407,565,373,994,962,204,688,245,775,245,197,802,797,626,951,245,245,245,981,780,481,88,14,245,917,245,521,673,776,245,517,915,921,892,245,437,979,987,392,245,619,927,797,306,528,245,861,245,509,538,552,691,838,245,476,646,252,924,245,245,245,245,396,488,589,225,916,750,203,265,822,719,245,584,892,429,245,305,245,245,978,739,245,889,425,936,245,245,245,11,179,388,833,680,245,245,583,522,745,323,715,959,383,343,440,587,932,447,824,816,245,936,920,965,756,245,245,659,454,649,692,185,245,147,380,512,154,146,245,939,674,245,559,940,684,315,854,289,730,786,468,245,245,597,558,535,728,401,647,425,383,629,674,575,245,245,942,373,880,245,245,815,245,245,245,957,903,613,547,236,239,408,699,791,946,471,914,906,245,245,245,412,245,440,245,450,245,245,843,245,2,856,432,245,699,667,620,416,389,245,397,358,245,381,510,245,74,245,539,257,245,1000,357,361,429,327,704,701,479,245,118,927,245,429,875,515,245,511,993,245,698,930,739,733,859,245,245,934,245,626,245,489,245,230,362,733,245,161,245,245,245,433,460,245,808,599,245,828,519,410,861,886,720,245,245,855,995,871,906,509,245,520,928,531,448,245,245,860,753,245,525,730,764,495,816,837,245,829,87,737,610,245,488,245,987,715,172,938,86,245,245,986,587,839,793,245,784,740,560,844,705,789,245,797,559,698,245,990,848,400,245,29,591,672,582,130,320,945,737,145,245,539,758,351,245,245,245,83,245,860,284,991,381,287,634,220,744,37,245,351,492,245,789,412,663,245,873,261,245,245,152,933,245,829,874,922,245])
# print(x)

# def test_1():
#     assert scoreOfStudents("7+3*1*2", [20,13,42]) == 7

# def test_2():
#     assert scoreOfStudents("3+5*2", [13,0,10,13,13,16,16]) == 19

# def test_3():
#     assert scoreOfStudents("6+0*1", [12,9,6,4,8,6]) == 10

# def test_4():
#     assert scoreOfStudents("6+3*6+2*9+9*4+9*9+5*9+6", [512,210,210,594,210,875,762,210,210,270,342,330,210,168,767,22,462,634,194,210,552,210,210,384,210,348,210,267,553,139,210,389,614,210,825,234,900,435,210,699,454,504,300,210,210,210,215,984,210,522,943,654,793,714,870,693,210,686,210,720,153,210,957,510,210,810,210,846,714,528,942,210,342,974,210,71,906,402,726,924,388,696,210,366,210,888,825,210,210,210,654,996,846,559,210,492,210,698,210,856,576,324,822,894,666,210,935,210,840,45,641,210,210,588,708,966,462,300,210,759,480,210]) == 291

# def task_5():
#     assert scoreOfStudents("7+8*2+3*7+8+9*5+4*8+8*5+8*9+4", [855,654,627,564,621,952,669,957,443,289,743,245,731,592,245,254,837,771,724,245,667,734,102,754,901,245,523,389,506,964,689,40,245,546,245,245,865,245,245,786,838,524,633,245,631,952,386,245,372,245,245,719,245,842,910,301,801,213,363,245,245,400,370,245,245,245,488,252,519,500,245,245,416,245,245,687,603,385,245,769,245,616,899,668,754,245,814,599,611,924,851,245,981,245,452,245,736,917,788,245,866,814,958,245,887,245,364,764,308,468,448,533,261,732,496,439,479,17,245,916,686,245,592,792,245,245,828,245,708,471,245,785,245,438,928,777,245,604,802,245,634,413,991,82,245,318,765,847,975,623,40,245,245,245,661,667,411,663,884,245,829,862,245,256,156,680,873,245,623,286,245,461,245,245,529,836,981,199,911,908,245,497,703,889,368,245,245,629,793,364,536,0,377,54,245,513,998,731,471,481,245,245,989,245,245,807,245,531,150,245,958,943,529,245,320,231,986,724,245,604,553,827,195,837,827,979,701,739,523,369,71,245,245,681,296,215,582,245,763,931,488,678,529,581,464,651,179,832,245,988,245,457,779,245,997,245,481,892,245,942,789,656,204,880,245,245,632,777,245,245,743,721,452,245,994,594,645,637,752,606,880,930,245,932,684,443,927,671,734,928,803,245,493,245,820,676,245,245,870,245,903,802,592,543,744,651,536,245,941,563,245,245,245,566,442,255,245,206,329,828,824,536,904,604,829,245,245,694,346,562,497,505,725,719,245,889,245,975,453,245,245,245,643,245,376,245,91,245,978,868,245,245,661,902,245,588,483,793,661,599,245,245,937,731,820,168,245,245,997,769,203,245,752,742,829,74,245,710,722,245,358,975,178,245,769,418,245,475,915,971,590,961,220,978,245,245,985,245,812,119,363,435,393,245,56,472,245,11,580,245,381,728,484,730,719,245,397,256,656,523,245,245,245,734,857,419,890,561,676,976,873,245,245,595,672,998,566,932,245,245,271,880,245,976,245,245,292,747,245,527,605,980,633,965,479,934,285,245,245,489,726,180,855,440,575,476,180,829,245,245,251,843,862,990,808,354,947,245,245,884,479,245,245,245,245,489,245,213,602,245,245,811,852,877,7,245,548,806,909,704,245,949,65,651,666,612,245,8,551,245,245,245,245,245,245,510,754,567,296,916,934,53,245,245,245,777,417,560,508,241,245,862,532,944,728,533,465,432,943,855,245,648,958,867,220,761,724,513,876,85,245,995,827,255,401,585,621,612,261,968,600,797,728,869,245,840,915,245,411,451,182,847,719,152,823,245,475,64,513,603,712,924,245,575,995,245,245,245,800,482,245,245,824,487,511,794,275,245,945,245,245,969,499,245,1000,245,631,102,510,539,210,245,703,472,245,245,670,245,208,245,245,245,245,684,154,918,903,245,928,768,592,912,29,744,54,245,650,583,245,245,177,245,464,383,245,858,602,723,884,617,245,529,245,381,227,677,479,336,826,742,897,110,245,721,16,245,662,728,441,245,858,838,48,245,971,646,872,245,422,171,679,865,245,245,245,765,320,739,857,245,585,347,245,893,684,958,482,245,195,751,617,325,918,878,595,927,447,621,723,532,945,245,609,245,300,546,765,245,963,852,245,245,417,245,534,682,291,41,489,245,697,245,560,802,245,245,245,731,245,245,759,245,726,668,245,923,928,245,33,487,606,958,649,381,245,988,747,543,879,594,245,245,370,952,245,535,245,979,401,997,529,672,681,245,969,879,646,876,968,968,734,686,245,245,725,513,292,173,245,548,245,915,771,245,401,890,525,934,245,706,245,245,488,245,245,644,914,26,245,426,827,245,543,245,693,245,245,482,245,245,673,35,523,916,837,245,949,584,51,245,889,74,245,784,857,245,245,736,569,380,964,245,245,390,737,871,165,894,51,245,724,118,745,705,245,863,245,245,116,443,343,245,949,245,800,121,540,849,630,245,245,486,245,598,525,245,668,425,312,739,219,245,758,405,536,288,245,245,850,497,245,245,287,245,972,248,469,245,844,528,475,783,245,479,245,245,990,485,530,806,187,245,730,252,784,26,768,217,921,561,543,245,682,245,588,313,245,777,245,588,254,927,500,716,245,711,769,245,546,423,245,651,23,245,336,662,927,787,753,245,433,726,709,933,973,956,884,840,945,892,245,245,483,717,832,992,447,584,516,358,305,952,839,555,819,687,272,178,245,245,480,845,683,724,245,947,245,611,876,245,898,245,245,762,946,245,951,311,450,966,974,352,141,553,245,599,245,746,245,741,885,729,737,785,245,580,844,598,245,245,245,174,245,245,572,707,150,794,636,536,104,794,245,637,623,488,528,245,651,245,679,689,245,993,928,663,658,568,388,245,930,546,245,720,908,166,764,245,245,152,252,245,919,309,604,245,245,544,974,901,50,176,855,361,245,245,701,369,532,245,245,505,688,245,227,821,739,647,984,150,621,730,919,494,289,245,245,540,793,672,156,383,245,666,25,775,117,678,733,770,644,245,245,245,245,661,843,826,353,245,747,559,748,245,386,245,245,993,542,627,903,540,868,245,590,386,706,861,860,245,971,245,245,989,121,855,822,245,199,559,711,245,631,928,622,503,170,801,289,245,245,981,516,674,245,922,730,242,764,440,732,574,245,803,775,735,245,245,690,489,844,245,404,606,245,102,245,886,245,847,5,926,556,1,245,245,190,704,58,245,396,814,726,245,133,164,824,797,4,164,443,245,378,97,135,718,785,531,245,973,644,245,245,796,222,405,379,245,245,937,245,245,379,760,595,245,245,782,964,838,762,617,796,884,475,915,245,808,582,659,774,681,29,677,245,402,849,738,391,245,229,212,524,600,974,604,850,560,949,905,396,245,909,631,245,947,881,918,958,245,69,756,964,245,826,932,245,245,245,792,561,220,245,972,892,169,947,868,798,850,553,854,245,745,305,748,698,653,245,862,245,881,513,96,289,921,749,245,836,782,723,424,845,245,717,569,735,560,245,245,811,231,466,987,245,652,948,972,245,245,245,664,245,161,749,412,655,640,245,836,669,565,245,869,860,98,245,814,186,956,245,590,728,803,245,711,245,245,245,245,780,245,525,245,245,245,921,245,559,464,686,408,245,245,908,245,535,959,572,245,245,551,119,847,632,245,622,58,946,518,283,245,245,621,503,698,793,1000,245,628,245,486,736,888,185,245,245,374,782,537,846,640,689,866,245,669,763,681,245,873,395,245,909,960,245,646,592,245,964,511,560,245,245,407,565,373,994,962,204,688,245,775,245,197,802,797,626,951,245,245,245,981,780,481,88,14,245,917,245,521,673,776,245,517,915,921,892,245,437,979,987,392,245,619,927,797,306,528,245,861,245,509,538,552,691,838,245,476,646,252,924,245,245,245,245,396,488,589,225,916,750,203,265,822,719,245,584,892,429,245,305,245,245,978,739,245,889,425,936,245,245,245,11,179,388,833,680,245,245,583,522,745,323,715,959,383,343,440,587,932,447,824,816,245,936,920,965,756,245,245,659,454,649,692,185,245,147,380,512,154,146,245,939,674,245,559,940,684,315,854,289,730,786,468,245,245,597,558,535,728,401,647,425,383,629,674,575,245,245,942,373,880,245,245,815,245,245,245,957,903,613,547,236,239,408,699,791,946,471,914,906,245,245,245,412,245,440,245,450,245,245,843,245,2,856,432,245,699,667,620,416,389,245,397,358,245,381,510,245,74,245,539,257,245,1000,357,361,429,327,704,701,479,245,118,927,245,429,875,515,245,511,993,245,698,930,739,733,859,245,245,934,245,626,245,489,245,230,362,733,245,161,245,245,245,433,460,245,808,599,245,828,519,410,861,886,720,245,245,855,995,871,906,509,245,520,928,531,448,245,245,860,753,245,525,730,764,495,816,837,245,829,87,737,610,245,488,245,987,715,172,938,86,245,245,986,587,839,793,245,784,740,560,844,705,789,245,797,559,698,245,990,848,400,245,29,591,672,582,130,320,945,737,145,245,539,758,351,245,245,245,83,245,860,284,991,381,287,634,220,744,37,245,351,492,245,789,412,663,245,873,261,245,245,152,933,245,829,874,922,245]) == 2150

if __name__ == '__main__':
    import pytest
    pytest.main([__file__])
